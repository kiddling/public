<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>公共艺术 学生版一键生成器 v5.4.0（主题句全局/矩阵→策略句） · Kiddoo Ling</title>
<style>
  :root{--bg:#0b1220; --panel:#0f172a; --card:#111827; --ink:#e5e7eb; --mut:#94a3b8; --acc:#60a5fa; --bd:#1f2937; --btn:#2563eb; --chip:#223044;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,#0b1220 0%,#0f172a 60%,#111827 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
  header{position:sticky;top:0;background:rgba(11,18,32,.75);backdrop-filter:blur(10px);border-bottom:1px solid #0f172a;z-index:20}
  .wrap{max-width:1140px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .sub{font-size:12px;color:#cbd5e1;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .tab{padding:10px 12px;border:1px solid #2a3b55;border-radius:10px;background:#0b1220;color:#cbd5e1;cursor:pointer;font-size:13px}
  .tab.active{background:linear-gradient(180deg,#3b82f6,#2563eb);border-color:#1d4ed8;color:#fff}
  .panel{display:none}
  .panel.active{display:block}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin:12px 0}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .title{font-size:14px;color:#cbd5e1;margin:8px 0}
  label{font-size:12px;color:#93c5fd;display:block;margin:4px 0 6px}
  select,input[type='text']{width:100%;padding:12px 36px 12px 12px;border:1px solid #273548;border-radius:12px;background:#0b1220;color:#e5e7eb;font-size:14px;outline:none;appearance:auto}
  textarea{width:100%;min-height:140px;background:#0b1220;color:#e5e7eb;border:1px solid #273548;border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--chip);border-radius:999px;background:#0b1220;color:#e5e7eb;font-size:13px;cursor:pointer}
  .btn{padding:9px 12px;border:1px solid #2a3b55;border-radius:10px;background:#0b1220;color:#e5e7eb;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border-color:#1d4ed8}
  .btn.warn{border-color:#ef4444;color:#ef9a9a}
  .mut{color:#9aa6b2;font-size:12px}
  .sectionTitle{display:flex;align-items:center;gap:8px;margin-bottom:6px;justify-content:space-between}
  .left{display:flex;align-items:center;gap:8px}
  .dot{width:24px;height:24px;border-radius:999px;background:#0b1220;border:1px solid #334155;display:grid;place-items:center;color:#93c5fd;font-size:12px}
  .bar{position:sticky;bottom:0;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-top:1px solid #0f172a;padding:10px;z-index:30}
  body:not(.dev) .sub{display:none}
  @media print{ header,.bar{display:none} body{background:#fff;color:#000} .card{box-shadow:none;border-color:#ddd} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>公共艺术 学生版一键生成器 v5.4.0（主题句全局/矩阵→策略句） · Kiddoo Ling</h1>
    <div class="sub">
      <span>四标签：发现问题｜选题细化｜设计概念与方案｜评估与总结</span>
      <span id="status" class="mut">（默认隐藏状态；?dev=1 显示）</span>
    </div>

    <div class="toolbar">
      <button class="btn" id="exportMD">导出 Markdown</button>
      <button class="btn" id="exportPDF">导出 PDF</button>
      <button class="btn warn" id="resetAll">清空重置</button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="tab1">发现问题</button>
      <button class="tab" data-tab="tab2">选题细化</button>
      <button class="tab" data-tab="tab3">设计概念与方案</button>
      <button class="tab" data-tab="tab4">评估与总结</button>
    </div>
  </div>
</header>

<div class="wrap" id="app">
  <div id="tab1" class="panel active">
    <div class="card">
      <div class="sectionTitle">
        <div class="left"><div class="dot">A</div><div class="title">场域与目标</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="fillDemo">示例填充</button>
        </div>
      </div>
      <div class="grid3">
        <div>
          <label>场域大类</label>
          <select id="siteCat">
            <option>交通/枢纽</option><option>公共广场</option><option>社区/居民区</option><option>历史/文脉节点</option>
            <option>公共家具</option><option>临时/节庆</option><option>数字/虚拟</option><option>景观走廊/绿廊</option>
          </select>
          <input type="text" id="siteCatCustom" placeholder="或手动输入场域大类" style="margin-top: 8px;">
        </div>
        <div>
          <label>具体条目</label>
          <select id="siteItem"></select>
          <input type="text" id="siteItemCustom" placeholder="或手动输入具体条目" style="margin-top: 8px;">
        </div>
        <div>
          <label>目标</label>
          <select id="target"><option>重要性（影响人群多）</option><option>紧迫性（高频/高风险）</option><option>可干预性（通过公共艺术可改善）</option></select>
          <input type="text" id="targetCustom" placeholder="或手动输入目标" style="margin-top: 8px;">
        </div>
      </div>
      <div id="siteHint" class="mut"></div>
      
      <div id="A-enhance" style="margin-top:8px">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="mut">快速选择呈现形式：</div>
          <div id="formChips" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px">
          <div id="aPreview" class="mut" style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">（预览）将在这里展示一句话摘要</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="applyToH">应用到 H 区主题句</button>
            <button class="btn warn" id="resetA">清空 A 项</button>
          </div>
        </div>
      </div>
      </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">B</div><div class="title">人群</div></div></div>
      <div class="grid2">
        <div>
          <label>核心人群</label>
          <select id="core"><option>政府/管理者</option><option>设计师和非遗传承人</option><option>居民</option><option selected>游客</option><option>物业/维护方</option></select>
        </div>
        <div>
          <label>相关人群（最多选2）</label>
          <div id="related" class="chips">
            <label class="chip"><input type="checkbox" value="政府/管理者">政府/管理者</label>
            <label class="chip"><input type="checkbox" value="设计师和非遗传承人">设计师和非遗传承人</label>
            <label class="chip"><input type="checkbox" value="居民">居民</label>
            <label class="chip"><input type="checkbox" value="游客" checked>游客</label>
            <label class="chip"><input type="checkbox" value="物业/维护方">物业/维护方</label>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">C</div><div class="title">功能与表达</div></div></div>
      <div class="grid2">
        <div>
          <label>公共艺术功能（选1–2）</label>
          <div id="functions" class="chips">
            <label class="chip"><input type="checkbox" value="审美与形象塑造">审美与形象塑造</label>
            <label class="chip"><input type="checkbox" value="场所营造与空间激活" checked>场所营造与空间激活</label>
            <label class="chip"><input type="checkbox" value="行为引导与导视" checked>行为引导与导视</label>
            <label class="chip"><input type="checkbox" value="社会凝聚与社区参与">社会凝聚与社区参与</label>
            <label class="chip"><input type="checkbox" value="教育与文化传承">教育与文化传承</label>
            <label class="chip"><input type="checkbox" value="纪念与公共记忆">纪念与公共记忆</label>
            <label class="chip"><input type="checkbox" value="生态与环境改善">生态与环境改善</label>
            <label class="chip"><input type="checkbox" value="安全与照明支持">安全与照明支持</label>
            <label class="chip"><input type="checkbox" value="经济与夜间活力">经济与夜间活力</label>
            <label class="chip"><input type="checkbox" value="数字互动与数据回路">数字互动与数据回路</label>
          </div>
        </div>
        <div>
          <label>呈现方式</label>
          <select id="modeSel"><option>环境设计向</option><option>工艺向</option><option>数字技术向</option><option>壁画向</option><option>雕塑及装置向</option><option selected>综合向</option></select>
          <div id="matHint" class="mut" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">D</div><div class="title">成本与周期</div></div></div>
      <div id="cost" class="chips">
        <label class="chip"><input type="radio" name="cost" value="极低（2万以下/4周）" checked>极低（2万以下/4周）</label>
        <label class="chip"><input type="radio" name="cost" value="低（2-5万/2月）">低（2-5万/2月）</label>
        <label class="chip"><input type="radio" name="cost" value="中（5-10万/3月）">中（5-10万/3月）</label>
        <label class="chip"><input type="radio" name="cost" value="高 （10万以上/半年到一年）">高 （10万以上/半年到一年）</label>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">E</div><div class="title">在地文化</div></div></div>
      <div id="local" class="chips">
        <label class="chip"><input type="checkbox" value="粤剧文化">粤剧文化</label>
        <label class="chip"><input type="checkbox" value="功夫文化">功夫文化</label>
        <label class="chip"><input type="checkbox" value="龙舟文化">龙舟文化</label>
        <label class="chip"><input type="checkbox" value="龙狮文化">龙狮文化</label>
        <label class="chip"><input type="checkbox" value="陶艺文化" checked>陶艺文化</label>
        <label class="chip"><input type="checkbox" value="工匠文化" checked>工匠文化</label>
        <label class="chip"><input type="checkbox" value="美食文化">美食文化</label>
        <label class="chip"><input type="checkbox" value="秋色文化">秋色文化</label>
        <label class="chip"><input type="checkbox" value="祖庙文化和忠义文化">祖庙文化和忠义文化</label>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">F</div><div class="title">生成主题句/Prompt</div></div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn primary" id="gen3">生成主题句</button>
        <button class="btn" id="genPrompt">生成研究Prompt</button>
        <button class="btn" id="copyOut1">复制</button>
      </div>
      <textarea id="out1" placeholder="生成后显示在这里。如果设置了自定义目标，将只生成一条主题句；否则生成三条。"></textarea>
    </div>
  </div>

  <div id="tab2" class="panel">
    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">H</div><div class="title">主题句（全局引用）</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="useFirstTheme">从上页取用主题句</button>
          <button class="btn warn" id="clearTheme">清空</button>
        </div>
      </div>
      <textarea id="themeBox" placeholder="请粘贴或输入你最终确定的【主题句】。后续 I~O 将自动引用此内容。"></textarea>
      <div class="mut">提示：此处的【主题句】将作为 I~O 的统一引用来源。</div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">I</div><div class="title">研究背景（第2页）</div></div>
        <button class="btn" id="fillI">填充提示词</button>
      </div>
      <textarea id="boxI" placeholder="在此撰写或粘贴研究背景输出"></textarea>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">J</div><div class="title">场地问题分析（第3页）</div></div>
        <button class="btn" id="fillJ">填充提示词</button>
      </div>
      <textarea id="boxJ" placeholder="在此撰写或粘贴场地问题分析输出"></textarea>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">L</div><div class="title">用户画像（第4页）</div></div>
        <button class="btn" id="fillL">填充提示词</button>
      </div>
      <textarea id="boxL" placeholder="在此撰写或粘贴用户画像输出"></textarea>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">K</div><div class="title">真实问题句与冲突点与目标（第5页）</div></div>
        <button class="btn" id="fillK">填充提示词</button>
      </div>
      <textarea id="boxK" placeholder="在此撰写或粘贴问题定义与目标设定"></textarea>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">M</div><div class="title">公共艺术介入策略矩阵（三目标×三核）（第6页）</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="fillM">填充模板+提示词</button>
          <button class="btn primary" id="deriveStrategy">从矩阵提炼【策略句】</button>
        </div>
      </div>
      <textarea id="boxM" placeholder="在此填写 3×3 矩阵及总述【策略句】"></textarea>
      <div class="mut">策略句存放：<span id="strategyEcho">（尚未生成）</span></div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">N</div><div class="title">多角色论证与政策对齐（第9页）</div></div>
        <button class="btn" id="fillN">填充提示词</button>
      </div>
      <textarea id="boxN" placeholder="在此撰写或粘贴多角色论证输出"></textarea>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="dot">O</div><div class="title">成本方案设计（第10页）</div></div>
        <button class="btn" id="fillO">填充提示词</button>
      </div>
      <textarea id="boxO" placeholder="在此撰写或粘贴四档成本设计输出"></textarea>
    </div>
  </div>

  <div id="tab3" class="panel">
    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="title">概念框架</div></div></div>
      <div class="grid2">
        <div>
          <label>表达口径</label>
          <div id="conceptStyle" class="chips">
            <label class="chip"><input type="radio" name="cstyle" value="叙事向（故事/在地文本）" checked>叙事向</label>
            <label class="chip"><input type="radio" name="cstyle" value="行为向（导视/互见不打扰）">行为向</label>
            <label class="chip"><input type="radio" name="cstyle" value="技术向（轻交互/数据回路）">技术向</label>
          </div>
          <input type="text" id="conceptStyleCustom" placeholder="或手动输入表达口径" style="margin-top: 8px;">
        </div>
        <div>
          <label>节点数量</label>
          <div id="nodes" class="chips">
            <label class="chip"><input type="radio" name="nodes" value="1个核心点" checked>1个核心点</label>
            <label class="chip"><input type="radio" name="nodes" value="2–3个分布点">2–3个分布点</label>
            <label class="chip"><input type="radio" name="nodes" value="3个以上的串联">3个以上的串联</label>
          </div>
          <input type="text" id="nodesCustom" placeholder="或手动输入节点数量" style="margin-top: 8px;">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="title">方案要点</div></div></div>
      <div class="grid3">
        <div><label>日间体验</label><input id="dayUX" placeholder="如：影子坐垫、导向阴影"></div>
        <div><label>夜间体验</label><input id="nightUX" placeholder="如：柔光轮廓、低亮引导"></div>
        <div><label>维护与撤场</label><input id="maintain" placeholder="如：模块更换≤60min、拆装≤8h"></div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="title">概念+方案输出</div></div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn primary" id="genConcept">生成概念与方案文本</button>
        <button class="btn" id="copyOut3">复制</button>
      </div>
      <textarea id="out3" placeholder="输出包含：概念一句话、三分法策略（审美/行为/技术）、节点与流线、日/夜两态、材料与做法、维护与撤场"></textarea>
    </div>
  </div>

  <div id="tab4" class="panel">
    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="title">指标与证据</div></div></div>
      <div class="grid3">
        <div>
          <label>选择 3–5 个 KPI（艺术语言）</label>
          <div id="kpis" class="chips">
            <label class="chip"><input type="checkbox" value="停留足迹（20/40/60s）">停留足迹</label>
            <label class="chip"><input type="checkbox" value="回声数（50/150/300次）">回声数</label>
            <label class="chip"><input type="checkbox" value="相机抬起率（15/25/35%）">相机抬起率</label>
            <label class="chip"><input type="checkbox" value="故事上墙（20/60/120）">故事上墙</label>
            <label class="chip"><input type="checkbox" value="温柔光（投诉=0）">温柔光</label>
            <label class="chip"><input type="checkbox" value="安静曲线（1/3/5 dB）">安静曲线</label>
            <label class="chip"><input type="checkbox" value="不打扰半径（2–3m≥80%）">不打扰半径</label>
            <label class="chip"><input type="checkbox" value="礼物环（10/30/60）">礼物环</label>
            <label class="chip"><input type="checkbox" value="儿童自来玩（5’/10’/15’）">儿童自来玩</label>
            <label class="chip"><input type="checkbox" value="回访愿望（60/75/85%）">回访愿望</label>
            <label class="chip"><input type="checkbox" value="路径变轻（−1/−3/−5）">路径变轻</label>
            <label class="chip"><input type="checkbox" value="夜间更友好（×0.6/×0.8/×1.0）">夜间更友好</label>
          </div>
        </div>
        <div><label>基线测量（Before）</label><input id="baseline" placeholder="如：高峰10min内眯眼人数、停留时长、噪声dB"></div>
        <div><label>复测计划（After）</label><input id="afterplan" placeholder="如：相同点位/时间段，方法一致拍照/计时"></div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="title">总结与反思</div></div></div>
      <div class="grid2">
        <div><label>风险与替代</label><input id="risk" placeholder="如：雨天停用/柔光替换；儿童攀爬加限位"></div>
        <div><label>叙事收尾</label><input id="closure" placeholder="如：留言墙/二次到访彩蛋"></div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle"><div class="left"><div class="title">评估输出</div></div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn primary" id="genEval">生成评估与总结文本</button>
        <button class="btn" id="copyOut4">复制</button>
      </div>
      <textarea id="out4" placeholder="输出包含：KPI清单、测量方法、样本与频次、风险与替代、总结收口"></textarea>
    </div>
  </div>

  <div class="mut">© 学生版 v5.4.0 · Kiddoo Ling（H~O 文本框与提示词；主题句全局；矩阵→策略句）</div>
</div>

<div class="bar">
  <div class="wrap" style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn primary" id="quickAll">一键串联（极简纯文本）</button>
    <button class="btn" id="copyMinimal">极简复制</button>
    <button class="btn" id="exportMinimalMD">极简导出 MD</button>
    <span class="mut">如需显示头部状态：链接加 <code>?dev=1</code></span>
  </div>
</div>

<script>
if(new URLSearchParams(location.search).get('dev')==='1'){ document.body.classList.add('dev'); }

const SITE_LIST = {
  "交通/枢纽":[
    {name:"佛山西站", hints:"导向艺术化·候车声景·门户标识"},
    {name:"新佛山站（广湛）", hints:"遮阳与地纹·信息可视化·慢行家具"}
  ],
  "公共广场":[
    {name:"世纪莲体育中心前广场", hints:"活动装置·夜跑光影·模块展具"},
    {name:"千灯湖中轴线", hints:"水岸看台装置·互动喷雾/灯光·市集展具"},
    {name:"季华园/季华路口袋点", hints:"可移展台·社区共创亭"}
  ],
  "社区/居民区":[
    {name:"敦厚/郊边城中村", hints:"门楼微介入·巷口长椅/灯具·骑楼阴影利用"},
    {name:"张槎织造老街", hints:"织纹导视·口述史“声音橱窗”·夜间照明优化"}
  ],
  "历史/文脉节点":[
    {name:"祖庙—岭南天地", hints:"多语导览·灰塑/木雕可视化·夜游光影"},
    {name:"南风古灶（石湾）", hints:"窑口时间线·互动拉坯·生火仪式演绎"},
    {name:"清晖园—大良老城", hints:"园林叙事导览·非遗工艺转译展件"},
    {name:"西樵松塘村/翰林带", hints:"祠堂前坪艺术·书写工作坊"},
    {name:"芦苞古镇", hints:"水口码头小品·口袋点更新"}
  ],
  "公共家具":[
    {name:"东平河滨江带", hints:"系列长椅·导向柱·桥头光影"},
    {name:"金融高新区/千灯湖", hints:"连廊驿站·信息亭·遮阳雨棚"},
    {name:"西站/新佛山站圈", hints:"候车遮阳·滴水檐·导向铺装"}
  ],
  "临时/节庆":[
    {name:"行通济（元宵）", hints:"巡游看台·互动灯箱·“生菜福”可视化"},
    {name:"佛山秋色（10月）", hints:"彩车侧展具·路口声景·导视皮肤"},
    {name:"九江龙舟", hints:"码头临建看台·赛道信息可视化·记忆装置"}
  ],
  "数字/虚拟":[
    {name:"佛山文化e网通", hints:"活动预约·积分/数字徽章·线上导览"},
    {name:"数字陶瓷博物馆×公共文化云", hints:"VR展厅·窑口数字学习路径"},
    {name:"“佛趣游”智慧文旅", hints:"AR打卡滤镜·任务化导览"}
  ],
  "景观走廊/绿廊":[
    {name:"东平河“一河两岸”", hints:"艺术栈道·桥体光影·夜游策展"},
    {name:"佛山新城8公里绿道", hints:"慢行里程碑·季节性光影"},
    {name:"千灯湖—桂城绿道", hints:"亲水台阶艺术化·草坡装置"}
  ]
};

function $(id){return document.getElementById(id);}
function checked(id,max=99){return Array.from(document.querySelectorAll(`#${id} input[type=checkbox]:checked`)).slice(0,max).map(x=>x.value);}
function radio(name){const x=document.querySelector(`input[name="${name}"]:checked`);return x?x.value:"";}
function uniq(a){return Array.from(new Set(a));}

function initSite(){
  const cat=$('siteCat'), item=$('siteItem');
  function refresh(){
    const list=SITE_LIST[cat.value]||[];
    item.innerHTML=list.map(o=>`<option data-h="${o.hints}">${o.name}</option>`).join("");
    const h=list.length?list[0].hints:"";
    // 只有在自定义输入为空时才显示下拉菜单的值
    if (!$('siteCatCustom').value.trim() && !$('siteItemCustom').value.trim()) {
      $('siteHint').textContent = `${cat.value}｜${item.value}｜提示：${h}`;
    } else {
      $('siteHint').textContent = `（已使用自定义输入）`;
    }
  }
  function updateHint(){
    const opt=item.selectedOptions[0];
    // 只有在自定义输入为空时才显示下拉菜单的值
    if (!$('siteCatCustom').value.trim() && !$('siteItemCustom').value.trim()) {
      $('siteHint').textContent = `${cat.value}｜${opt?opt.value:""}｜提示：${opt?opt.dataset.h||"":""}`;
    } else {
      $('siteHint').textContent = `（已使用自定义输入）`;
    }
  }
  cat.addEventListener('change', refresh);
  item.addEventListener('change', updateHint);
  refresh();
}

const periodByCost={"极低（2万以下/4周）":"4周","低（2-5万/2月）":"2月","中（5-10万/3月）":"3月","高 （10万以上/半年到一年）":"半年到一年"};
const goalByFunc={
  "审美与形象塑造":["好感度≥75/100","自发拍照≥30次/日"],
  "场所营造与空间激活":["平均停留≥20s","活跃点≥3处"],
  "行为引导与导视":["通行净宽≥1.8m","逆行率≤5%"],
  "社会凝聚与社区参与":["参与≥20人/周","覆盖≥2类人群"],
  "教育与文化传承":["关键词识别率≥60%","导览完成率≥60%"],
  "纪念与公共记忆":["合影≥30次/日","留言≥10条/日"],
  "生态与环境改善":["噪声≤55dB","眩光值达标"],
  "安全与照明支持":["照度达标","事故/投诉=0"],
  "经济与夜间活力":["夜间停留≥30s","夜间客流↑≥10%"],
  "数字互动与数据回路":["并发≥100","延迟≤200ms"]
};

// ctx() 函数：确保了自定义输入优先
function ctx(){
  const siteCatManual = $('siteCatCustom')?.value.trim();
  const siteItemManual = $('siteItemCustom')?.value.trim();
  const targetManual = $('targetCustom')?.value.trim();
  
  // 核心逻辑：如果手动输入非空，则使用手动输入，否则使用下拉菜单的值
  const cat = siteCatManual || $('siteCat').value;
  const item = siteItemManual || $('siteItem').value;
  const target = targetManual || $('target').value;
  
  const core=$('core').value, rel=checked('related',2);
  const mode=$('modeSel').value, funcs=checked('functions',2), cost=radio('cost'), local=checked('local',3);
  
  const site=`${cat}（${item}）`, period=periodByCost[cost]||"4周";
  return {cat,item,site,core,rel,mode,funcs,cost,local,target,period};
}

function goalLead(f){ 
  if(f.includes("重要性")) return "为了覆盖更多使用者"; 
  if(f.includes("紧迫性")) return "为应对高频/高风险问题"; 
  if(f.includes("可干预性")) return "考虑公共艺术的快速可干预点"; 
  // 对于自定义目标，提供一个中性的引导
  return "为实现该目标"; 
}

function goals(funcs,focus){
  const base=[]; (funcs||[]).slice(0,2).forEach(f=>(goalByFunc[f]||[]).forEach(x=>base.push(x)));
  if(focus.includes("重要性")) return uniq(["触达≥60%核心人群","活跃点≥3处",...base]).slice(0,3);
  if(focus.includes("紧迫性")) return uniq(["投诉=0","逆行率≤5%","眩光值达标",...base]).slice(0,3);
  // 无论是“可干预性”还是自定义目标，都侧重于快速实现/维护目标
  return uniq(["原型≤14天搭建","维护≤2次/月","拆装≤8小时",...base]).slice(0,3);
}

function sentence(focus,c){
  const local=c.local.length?c.local.join("、"):"在地关键词"; const tag=(c.funcs[0]||"公共艺术功能");
  const rel=c.rel.length?`及${c.rel.join("、")}`:"";
  const g=goals(c.funcs,focus).join("、"); const lead=goalLead(focus);
  
  // 修正：确保主题句的【目标】部分使用传入的 focus
  return `【目标：${focus}】${lead}。在${c.site}里，对于${c.core}${rel}，存在【主要困扰与需求】。我们希望通过${c.mode}的公共艺术，结合【${local}】的在地文化，选用${c.cost}方案，解决【${focus}】，实现【${tag}】；并设定【${g}】（周期：${c.period}）。`;
}

document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click', e=>{
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(btn.dataset.tab).classList.add('active');
}));

document.addEventListener('click', (e)=>{
  if(e.target.id==='gen3'){ 
    const c=ctx(); 
    const customTarget = $('targetCustom').value.trim();
    let focuses = [];
    
    // 关键修复：根据自定义输入决定生成主题句的数量和内容
    if (customTarget) {
      // 仅生成一条主题句，使用自定义目标
      focuses = [customTarget]; 
    } else {
      // 保持原逻辑：生成三条主题句，使用下拉菜单的预设目标
      focuses = ["重要性（影响人群多）","紧迫性（高频/高风险）","可干预性（通过公共艺术可改善）"]; 
    }
    
    $('out1').value = focuses.map(f=>sentence(f,c)).join("\n\n"); 
  }
  
  if(e.target.id==='genPrompt'){ 
    const c=ctx(); 
    // 获取当前 A 项最终确定的目标（自定义优先）
    const targetValue = $('targetCustom').value.trim() || $('target').value; 
    
    $('out1').value = `研究助手，请围绕「${c.site}」的公共艺术展开虚拟研究，并聚焦于【目标：${targetValue}】:
1）网络检索“政策/场地/文化”三类资料（含：${c.local.join("、")||"在地文化"}），整理出处链接。
2）依据资料与观察，归纳【场地问题】配对（问题—影响—证据），5–8条。
3）针对【${c.core}${c.rel.length? "，及"+c.rel.join("、"):""}】总结主要困扰与需求，5–8条（≤40字/条）。
4）提出【${(c.funcs.join("、")||"公共艺术功能")}】导向的策略与材料做法（${c.mode}，${c.cost}，周期${c.period}），并给出监测方式与目标。`; 
  }
  
  if(e.target.id==='copyOut1'){ navigator.clipboard.writeText($('out1').value); }

  if(e.target.id==='useFirstTheme'){ const first = ($('out1').value||'').split('\n').filter(x=>x.trim()).shift()||''; $('themeBox').value = first; }
  if(e.target.id==='clearTheme'){ $('themeBox').value=''; }

  if(e.target.id==='fillI'){ const c=ctx(); const t=THEME(); $('boxI').value = `【提示词｜研究背景（第2页）】
围绕主题句「${t}」，搜索省/市/区的相关政策、${c.item}的场地背景与在地文化（含：${c.local.join("、")||"在地线索"}）。
请分别在三类下列出与主题密切相关的 5 条信息（每条≤10字），并附 2–3 个来源链接：
· 政策背景（5条）
· 场地背景（5条）
· 文化背景（5条）`; }

  if(e.target.id==='fillJ'){ const t=THEME(); $('boxJ').value = `【提示词｜场地问题分析（第3页）】
根据主题句「${t}」总结场地存在的问题，按类别列出（每条≤20字），每条包含：问题｜证据｜需求。
输出示例（每行一条）：
动线冲突｜高峰逆行/堆积录像｜需要分层导流
眩光刺眼｜投诉记录/眯眼计数｜需要柔化光线
噪声过高｜分贝计/用户反馈｜需要削峰降噪`; }

  if(e.target.id==='fillL'){ const c=ctx(); const t=THEME(); const people = [c.core].concat(c.rel).join('、'); $('boxL').value = `【提示词｜用户画像（第4页）】
围绕主题句「${t}」，针对【${people}】在该场域的**核心问题**，从「动机/痛点/期望」三方面，细分并给出用户画像（每条≤15字）。
输出格式建议：
· 动机：……（≤15字）
· 痛点：……（≤15字）
· 期望：……（≤15字）
（可按人群子类各给 1–2 条）`; }

  if(e.target.id==='fillK'){ const t=THEME(); $('boxK').value = `【提示词｜真实问题句与冲突点与目标（第5页）】
基于主题句「${t}」进行问题定义：
1）核心问题陈述：描述最核心问题、具体表现与影响（≤60字）。
2）冲突点分析：如“导流 vs 停留”“安静 vs 热闹”等（每条≤15字，3–5条）。
3）目标方向：面向功能/社会/文化三类提出目标（每类1–2条，≤15字）。`; }

  if(e.target.id==='fillM'){ const t=THEME(); $('boxM').value = `【模板｜公共艺术介入策略矩阵（第6页）】
围绕真实问题「${t}」，填写 3×3 策略矩阵（避免“提升体验”等抽象词；每格≤12字）：
维度：三目标（功能性/社会性/文化性） × 三核（场所/人群/运营）

功能×场所：
功能×人群：
功能×运营：

社会×场所：
社会×人群：
社会×运营：

文化×场所：
文化×人群：
文化×运营：

【请在末尾给出 1 句总述策略（策略句，≤20字）】`; }

  if(e.target.id==='deriveStrategy'){
    const raw = $('boxM').value||'';
    const m = raw.match(/策略句[：:]\s*([^\n]+)/);
    let strategy = m ? (m[1]||"").trim() : "";
    if(!strategy){
      const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
      const picks = lines.filter(l=>/×/.test(l) && l.includes('：')).slice(0,3).map(l=>l.split('：')[1]||'').join('、');
      strategy = picks ? `以「${picks}」为核心的轻量介入` : "以在地纹样与导流微介入为核心";
    }
    window._STRATEGY_SENTENCE = strategy;
    $('strategyEcho').textContent = strategy ? `已生成：${strategy}` : '（尚未生成）';
  }

  if(e.target.id==='fillN'){ const s = STRATEGY(); $('boxN').value = `【提示词｜多角色论证与政策对齐（第9页）】
针对策略：「${s}」，从政府/管理者、公共艺术设计师（含非遗传承人）、市民、游客、物业五类角色进行论证，每角色 3–4 句：
· 支持点（为什么可行/好处）
· 潜在风险（可能的副作用/情境）
· 关键指标（如何判定有效）
并补充与相关政策的对齐点（条例/红线/标准条款编号）。`; }

  if(e.target.id==='fillO'){ const s = STRATEGY(); $('boxO').value = `【提示词｜成本方案设计（第10页）】
围绕策略：「${s}」，请分别给出四档成本的**详细设计策略**（含材料/做法/节点数量/安装与撤场/维护），并标注周期：
· 极低（2万以下/4周）：
· 低（2–5万/2月）：
· 中（5-10万/3月）：
· 高（10万以上/半年到一年）：`; }

  if(e.target.id==='genConcept'){ genConcept(); }
  if(e.target.id==='copyOut3'){ navigator.clipboard.writeText($('out3').value); }
  if(e.target.id==='genEval'){ genEval(); }
  if(e.target.id==='copyOut4'){ navigator.clipboard.writeText($('out4').value); }
  if(e.target.id==='exportPDF'){ window.print(); }

  if(e.target.id==='exportMD'){ const txt = minimal(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt],{type:"text/markdown;charset=utf-8"})); a.download="公共艺术_合成器_简版汇总_v5_4_0.md"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
  if(e.target.id==='exportMinimalMD'){ const md = minimal(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([md],{type:"text/markdown;charset=utf-8"})); a.download="公共艺术_合成器_极简_v5_4_0.md"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
  if(e.target.id==='copyMinimal'){ navigator.clipboard.writeText(minimal()); }
  if(e.target.id==='quickAll'){ const all = minimal(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([all],{type:"text/plain;charset=utf-8"})); a.download = "公共艺术_合成器_极简串联_v5_4_0.txt"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
  if(e.target.id==='resetAll'){ hardReset(); }
});

function THEME(){ return $('themeBox').value.trim() || '（请在H栏输入主题句）'; }
function STRATEGY(){ return window._STRATEGY_SENTENCE || '（请先在M栏提炼策略句）'; }

const matLib={
  "环境设计向":{ L:["竹/木拼装","帆布遮阳"], M:["耐候钢小构件","预制台阶坐凳"] },
  "工艺向":{ L:["竹编/纸浆","再生木"], M:["陶板/金属薄件"], H:["耐候钢+石材微结构"] },
  "数字技术向":{ L:["声音采样+本地播放","小型LED条"], M:["投影mapping小尺度","传感+控制节点"] },
  "壁画向":{ L:["抗涂鸦膜+线稿叙事"], M:["釉下彩/陶板拼"] },
  "雕塑及装置向":{ L:["模块化轻框架","绳网/织物皮肤"], M:["耐候钢轻体量+可拆基座"] },
  "综合向":{ L:["混合轻材料（竹/布/绳）"], M:["金属+木/陶板+光影小件"] }
};
function matHintUpdate(){
  const mode=$('modeSel').value;
  const cost=radio('cost');
  const tier=/极低|低/.test(cost)?"L":/中/.test(cost)?"M":"H";
  const list=(matLib[mode]||{})[tier]||(matLib[mode]||{}).L||[];
  $('matHint').textContent = list.length? `建议材料/做法：${list.join("、")}`:"";
}

// 新增概念上下文函数
function conceptCtx(){
  // Fallback for ctx if it hasn't loaded yet
  const c = window.ctx && typeof window.ctx === 'function' ? window.ctx() : {site:'目标场域', mode:'综合向', cost:'极低', period:'4周'};

  const cstyleManual = $('conceptStyleCustom')?.value.trim();
  const nodesManual = $('nodesCustom')?.value.trim();

  // Prioritize manual input, otherwise use checked value, stripping the parenthesis content for cstyle
  const cstyleFull = document.querySelector('input[name="cstyle"]:checked')?.value || '叙事向（故事/在地文本）';
  const cstyleDefault = cstyleFull.split('（')[0];
  const cstyle = cstyleManual || cstyleDefault;

  const nodes = nodesManual || document.querySelector('input[name="nodes"]:checked')?.value || '1个核心点';

  const dayUX = $('dayUX').value.trim()||"影子坐垫、导向阴影";
  const nightUX = $('nightUX').value.trim()||"柔光轮廓、低亮引导";
  const maintain = $('maintain').value.trim()||"模块更换≤60min、拆装≤8h";
  
  const strategy = window.STRATEGY ? window.STRATEGY() : '（请先在M栏提炼策略句）';
  
  const planPoints = [dayUX, nightUX, maintain].filter(Boolean).join('、');

  return {
    strategy, cstyle, nodes, dayUX, nightUX, maintain, planPoints,
    ...c // Include base context
  };
}

// 替换 genConcept 函数
function genConcept(){
  const cc=conceptCtx(); // 使用新的概念上下文
  
  // 按照用户要求重写 prompt/输出文本
  const newHeader = `设计概念与设计需求单（第11、12、14、16页）
温馨提示：设计策略中【主要困扰与需求】需要在AI中生成后自行放进框中`;

  const newInstructions = `
1、设计方案：根据【${cc.strategy}】的设计策略，以【${cc.cstyle}】的概念框架，对【${cc.nodes}】进行空间节点设计，在这个场域中设计公共艺术方案，重点关注【${cc.planPoints}】；以此形成设计概念： 1）设计概念总览：①一句话概括；②方案的设计概念，（上位规划、问题（场地、人群需求）、设计和运营策略、愿景）。2）节点的系列概念方案，解决的问题（包括但不限于主要问题、解决策略、预期效果、适用场景、运营策略），设计亮点（包括但不限于设计元素、设计方案、材料选择），技术实现路径。关系图（文字描述）：3）概念方案的设计意向图promt（总览意向图、节点特写意向图、白天意向图、夜景意向图）

2、研究题目：凝练该设计方案为参考题目，可参考以下方向。
设计向的题目-格式为【设计概念：8-10字的对仗题目，能够概括表达方案内容】：【应用场域/群体 + 表达方式】”；
研究向的题目：基于【理论/方法】的【研究对象】的【研究主题/问题】研究 —— 以【案例/场域】为例或【研究主题/问题】导向下的【研究对象】设计研究 —— 基于【理论/方法】。`;
  
  // 原有的内容结构可以作为 AI 辅助创作的参考，但应以用户要求的新 Prompt 结构为主
  $('out3').value = `${newHeader}\n\n${newInstructions}`;
}

function genEval(){
  const c=ctx();
  const ksel=Array.from(document.querySelectorAll('#kpis input:checked')).map(x=>x.value);
  const base=$('baseline').value||"记录高峰时段的停留/眯眼/噪声";
  const after=$('afterplan').value||"同点位/同方法复测，并收集UGC";
  const risk=$('risk').value||"雨天停用/降噪；儿童攀爬加限位";
  const closure=$('closure').value||"留言墙收口+二次到访彩蛋";
  $('out4').value = `【评估计划】
KPI：${(ksel.length? ksel.join("、") : goals(c.funcs, c.target).join("、"))}
基线（Before）：${base}
复测（After）：${after}
样本与频次：高峰时段×2日；每次10–15分钟；点位≥3。

【风险与替代】${risk}
【总结与收口】${closure}`;
}

function minimal(){
  const parts=[];
  const t=$('themeBox').value.trim(); if(t) parts.push(t);
  ['boxI','boxJ','boxL','boxK','boxM','boxN','boxO','out3','out4'].forEach(id=>{ const v=$(id).value.trim(); if(v) parts.push(v); });
  return parts.join('\n\n').replace(/\n{3,}/g,'\n\n');
}

function hardReset(){
  ['out1','boxI','boxJ','boxL','boxK','boxM','boxN','boxO','out3','out4','themeBox','dayUX','nightUX','maintain','baseline','afterplan','risk','closure', 'siteCatCustom', 'siteItemCustom', 'targetCustom', 'conceptStyleCustom', 'nodesCustom'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
  document.querySelectorAll('#related input[type=checkbox], #functions input[type=checkbox], #local input[type=checkbox], #kpis input[type=checkbox]').forEach(inp=>{ inp.checked=false; });
  $('core').value='游客';
  document.querySelector('input[name="cost"][value="极低（2万以下/4周）"]').checked=true;
  document.querySelector('input[name="cstyle"][value="叙事向（故事/在地文本）"]').checked=true;
  document.querySelector('input[name="nodes"][value="1个核心点"]').checked=true;
  window._STRATEGY_SENTENCE = '';
  initSite(); matHintUpdate();
}

function init(){
  initSite(); matHintUpdate();
  $('siteCat').value='公共广场'; $('siteCat').dispatchEvent(new Event('change'));
  const si = $('siteItem'); for(let i=0;i<si.options.length;i++){ if(si.options[i].value==='千灯湖中轴线'){ si.selectedIndex=i; break; } }
  $('fillDemo').addEventListener('click', ()=>{
    $('siteCat').value='公共广场'; $('siteCat').dispatchEvent(new Event('change'));
    const si = $('siteItem'); for(let i=0;i<si.options.length;i++){ if(si.options[i].value==='千灯湖中轴线'){ si.selectedIndex=i; break; } }
    $('target').value='紧迫性（高频/高风险）';
    $('core').value='游客';
    document.querySelectorAll('#related input[type=checkbox]').forEach(c=>c.checked=false);
    document.querySelector('#related input[value="居民"]').checked=true;
    document.querySelector('#functions input[value="行为引导与导视"]').checked=true;
    document.querySelector('#functions input[value="场所营造与空间激活"]').checked=true;
    $('modeSel').value='综合向'; matHintUpdate();
    // Clear custom fields on demo fill
    if($('siteCatCustom')) $('siteCatCustom').value = '';
    if($('siteItemCustom')) $('siteItemCustom').value = '';
    if($('targetCustom')) $('targetCustom').value = '';
  });
}
document.addEventListener('DOMContentLoaded', init);

// --- A: Enhance with form chips, live preview, persistence, and apply-to-H ---
(function(){
  const $ = (id)=>document.getElementById(id);
  
  const aCat = $('siteCat'); 
  const aPos = $('siteItem'); 
  const aTarget = $('target');

  const aCatC = $('siteCatCustom'); 
  const aPosC = $('siteItemCustom'); 
  const aTargetC = $('targetCustom');

  const preview = $('aPreview');
  const applyBtn = $('applyToH'), resetBtn = $('resetA');

  function refreshChips(){
    // Placeholder for future form chip logic
  }
  
  function buildPreview(){
    if(!preview) return;
    
    // 使用 ctx() 确保读取到的是自定义输入优先的最终值
    const c = window.ctx? window.ctx(): {site:'目标场域', mode:'在地表达', target:'重要性（影响人多）'}; 

    const site = c.site; 
    const form = c.mode; 
    const focus = c.target; 

    let text = '';
    try{
      if(typeof window.sentence === 'function'){
        // Re-calculate sentence using current context based on all inputs
        text = window.sentence(focus, c);
      }else{
        text = `在${site||'目标场域'}，围绕呈现形式（${form||'在地表达'}），针对最主要的核心人群，聚焦（${focus||'重要性（影响人多）'}）目标，提出公共艺术介入的主题句。`;
      }
    }catch(e){
      text = `在${site||'目标场域'}，围绕呈现形式（${form||'在地表达'}），针对最主要的核心人群，聚焦（${focus||'重要性（影响人多）'}）目标。`;
    }
    preview.textContent = '（预览）' + text;
  }
  
  function applyToH(){
    const box = document.getElementById('themeBox');
    if(!box) return;
    
    const c = window.ctx? window.ctx(): {};
    // 使用 ctx() 中确定的最终目标
    const focus = c.target || '重要性（影响人多）';

    const text = (typeof window.sentence==='function')
      ? window.sentence(focus, c)
      : (preview?.textContent||'').replace('（预览）','').trim();
      
    if(text){ box.value = text; window._THEME_SENTENCE = text; box.scrollIntoView({behavior:'smooth', block:'center'}); }
  }
  
  function resetA(){
    // Reset custom fields
    if(aCatC) aCatC.value = '';
    if(aPosC) aPosC.value = '';
    if(aTargetC) aTargetC.value = '';

    // Reset select fields 
    if(aCat) aCat.selectedIndex = 0;
    if(typeof Event==='function' && aCat){ aCat.dispatchEvent(new Event('change')); }
    if(aTarget) aTarget.selectedIndex = 0;
    
    saveAState();
    refreshChips();
    buildPreview();
  }
  
  const KEY='A_FOUR_STATE_V1';
  function saveAState(){
    const data = {
      // Save select states
      aCat:aCat?.value||'', aPos:aPos?.value||'', aTarget:aTarget?.value||'',
      // Save custom input states (using new IDs)
      aCatC:aCatC?.value||'', aPosC:aPosC?.value||'', aTargetC:aTargetC?.value||''
    };
    try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){}
  }
  
  function loadAState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      
      // Load select states
      if(aCat && d.aCat){ aCat.value = d.aCat; aCat.dispatchEvent(new Event('change')); }
      if(aPos && d.aPos){ aPos.value = d.aPos; aPos.dispatchEvent(new Event('change')); }
      if(aTarget && d.aTarget){ aTarget.value = d.aTarget; }
      
      // Load custom input states
      if(aCatC) aCatC.value = d.aCatC||'';
      if(aPosC) aPosC.value = d.aPosC||'';
      if(aTargetC) aTargetC.value = d.aTargetC||'';
      
    }catch(e){}
  }
  
  // Attach event listeners to all related fields
  [aCat,aPos,aTarget,aCatC,aPosC,aTargetC, $('siteItem')].forEach(el=>{
    if(el) el.addEventListener('input', ()=>{ saveAState(); buildPreview(); });
    if(el) el.addEventListener('change', ()=>{ saveAState(); buildPreview(); });
  });

  if(applyBtn) applyBtn.addEventListener('click', applyToH);
  if(resetBtn) resetBtn.addEventListener('click', resetA);

  setTimeout(()=>{ refreshChips(); buildPreview(); loadAState(); refreshChips(); buildPreview(); }, 0);
  aPos && aPos.addEventListener('change', ()=>{ setTimeout(refreshChips, 0); });
  aCat && aCat.addEventListener('change', ()=>{ setTimeout(refreshChips, 0); });
})();
</script>
</body>
</html>
