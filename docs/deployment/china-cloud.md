# China Cloud Deployment Guide (中国云部署指南)

本指南详细说明如何在中国大陆主流云服务商（阿里云和腾讯云）上部署 Nuxt + Strapi 项目。

## 服务器规格建议 (Server Sizing)

### 开发/测试环境 (Development/Staging)

#### Nuxt 前端服务器
- **CPU**: 2 核
- **内存**: 4GB
- **存储**: 40GB SSD
- **带宽**: 3Mbps
- **推荐实例**:
  - 阿里云: ecs.t6-c1m2.large
  - 腾讯云: S5.MEDIUM4

#### Strapi CMS 服务器
- **CPU**: 2 核
- **内存**: 4GB
- **存储**: 40GB SSD
- **带宽**: 3Mbps
- **推荐实例**:
  - 阿里云: ecs.t6-c1m2.large
  - 腾讯云: S5.MEDIUM4

#### PostgreSQL 数据库
- **CPU**: 2 核
- **内存**: 4GB
- **存储**: 100GB SSD
- **推荐**:
  - 阿里云 RDS PostgreSQL 基础版
  - 腾讯云 PostgreSQL 基础版

### 生产环境 (Production)

#### Nuxt 前端服务器 (负载均衡后端)
- **CPU**: 4 核
- **内存**: 8GB
- **存储**: 80GB SSD
- **带宽**: 5Mbps
- **实例数量**: 至少 2 台（用于高可用）
- **推荐实例**:
  - 阿里云: ecs.c6.xlarge
  - 腾讯云: S5.LARGE8

#### Strapi CMS 服务器
- **CPU**: 4 核
- **内存**: 8GB
- **存储**: 80GB SSD
- **带宽**: 5Mbps
- **实例数量**: 2 台（主备）
- **推荐实例**:
  - 阿里云: ecs.c6.xlarge
  - 腾讯云: S5.LARGE8

#### PostgreSQL 数据库
- **CPU**: 4 核
- **内存**: 16GB
- **存储**: 500GB SSD
- **推荐**:
  - 阿里云 RDS PostgreSQL 高可用版（主备架构）
  - 腾讯云 PostgreSQL 双机热备版

#### Redis 缓存
- **内存**: 2GB
- **推荐**:
  - 阿里云 Redis 标准版
  - 腾讯云 Redis 标准版

## 安全组配置 (Security Groups)

### 前端服务器 (Frontend Server)

#### 入站规则 (Inbound Rules)
| 协议 | 端口范围 | 源地址 | 说明 |
|------|---------|--------|------|
| TCP | 80 | 0.0.0.0/0 | HTTP |
| TCP | 443 | 0.0.0.0/0 | HTTPS |
| TCP | 22 | 管理员 IP | SSH (仅限管理员 IP) |
| TCP | 3000 | SLB/CLB IP | Nuxt 应用端口（仅限负载均衡） |

#### 出站规则 (Outbound Rules)
| 协议 | 端口范围 | 目标地址 | 说明 |
|------|---------|----------|------|
| TCP | 1337 | CMS 服务器 IP | Strapi API |
| TCP | 80, 443 | 0.0.0.0/0 | 访问外部服务 |
| TCP | 6379 | Redis IP | Redis 连接 |

### CMS 服务器 (CMS Server)

#### 入站规则 (Inbound Rules)
| 协议 | 端口范围 | 源地址 | 说明 |
|------|---------|--------|------|
| TCP | 1337 | 前端服务器 IP | Strapi API（仅限前端服务器） |
| TCP | 22 | 管理员 IP | SSH (仅限管理员 IP) |
| TCP | 80, 443 | 0.0.0.0/0 | CMS 管理后台访问 |

#### 出站规则 (Outbound Rules)
| 协议 | 端口范围 | 目标地址 | 说明 |
|------|---------|----------|------|
| TCP | 5432 | RDS IP | PostgreSQL |
| TCP | 6379 | Redis IP | Redis 连接 |
| TCP | 80, 443 | 0.0.0.0/0 | OSS/COS 上传 |

### 数据库服务器 (Database)

#### 入站规则 (Inbound Rules)
| 协议 | 端口范围 | 源地址 | 说明 |
|------|---------|--------|------|
| TCP | 5432 | CMS 服务器 IP | PostgreSQL（仅限应用服务器） |

## ICP 备案流程 (ICP Filing Steps)

### 什么是 ICP 备案？

ICP 备案是中国大陆境内所有网站必须完成的合法手续。未经备案的域名无法在中国大陆访问。

### 备案类型

1. **ICP 备案**：适用于非经营性网站（信息展示类）
2. **ICP 经营许可证**：适用于经营性网站（电商、会员付费等）

本项目通常需要 ICP 备案。如果涉及在线交易，可能需要 ICP 经营许可证。

### 备案流程

#### 1. 准备材料

**企业备案需要**:
- 营业执照副本扫描件
- 企业法人身份证正反面扫描件
- 网站负责人身份证正反面扫描件
- 网站负责人手机号和电子邮箱
- 域名证书
- 网站负责人幕布照片（由云服务商提供幕布）

**个人备案需要**:
- 个人身份证正反面扫描件
- 手机号和电子邮箱
- 域名证书
- 个人幕布照片

#### 2. 在云服务商平台提交备案

**阿里云备案流程**:
1. 登录 [阿里云 ICP 代备案管理系统](https://beian.aliyun.com/)
2. 填写主体信息（企业或个人）
3. 填写网站信息
4. 上传备案资料
5. 完成真实性核验（人脸识别或幕布拍照）
6. 提交初审

**腾讯云备案流程**:
1. 登录 [腾讯云备案系统](https://console.cloud.tencent.com/beian)
2. 进入备案流程，选择备案类型
3. 填写主体信息和网站信息
4. 上传资料并完成核验
5. 提交初审

#### 3. 等待审核

- **云服务商初审**: 1-2 个工作日
- **管局审核**: 3-20 个工作日（各省不同）

#### 4. 备案完成

收到备案号后（格式：京 ICP 备 XXXXXXXX 号），必须在网站底部添加备案号并链接到 [工信部备案查询网站](https://beian.miit.gov.cn/)。

### 备案期间的临时访问方案

在备案期间，域名无法使用。可以采用以下临时方案：
1. 使用云服务器的公网 IP 地址直接访问
2. 使用已备案的域名（如果有）
3. 使用境外服务器（香港、新加坡等）进行临时部署

### 重要注意事项

- 备案的域名必须与服务器位置匹配（在哪个省备案，服务器就要在哪个省）
- 网站内容必须合法合规，不得涉及违禁内容
- 备案信息变更（如网站负责人、服务器变更）需要及时更新备案信息
- 未备案域名解析到境内服务器将被阻断访问

## 网络和 CDN 考虑

### 国内 CDN 选择

1. **阿里云 CDN**: 覆盖全国，节点多，稳定性好
2. **腾讯云 CDN**: 价格优惠，适合中小型项目
3. **七牛云 CDN**: 易用性好，适合图片和视频加速
4. **又拍云 CDN**: 性价比高

详见 [cdn-strategy.md](./cdn-strategy.md)。

### 对象存储选择

- **阿里云 OSS**: 稳定，与阿里云 CDN 深度集成
- **腾讯云 COS**: 价格合理，与腾讯云 CDN 集成好
- **七牛云 Kodo**: 易用，有免费额度

配置 Strapi 使用对象存储参见 [Strapi Upload Providers](https://market.strapi.io/providers).

## 部署架构示例

### 生产环境架构

```
[用户] 
  ↓
[CDN (阿里云/腾讯云)]
  ↓
[负载均衡器 SLB/CLB]
  ↓
[Nuxt 前端集群] (2+ 实例) ←→ [Redis 缓存]
  ↓
[Strapi CMS] (主备) ←→ [PostgreSQL (主备)]
  ↓
[对象存储 OSS/COS]
```

### 网络隔离建议

1. 使用 VPC (Virtual Private Cloud) 隔离网络
2. 前端服务器放在公网子网
3. CMS 和数据库放在私有子网
4. 使用安全组严格控制访问权限

## 部署检查清单

- [ ] 服务器已购买并完成初始化
- [ ] 安全组规则已配置
- [ ] 域名已购买并完成 ICP 备案
- [ ] SSL 证书已申请（推荐使用免费的 Let's Encrypt）
- [ ] PostgreSQL 数据库已创建
- [ ] Redis 实例已创建
- [ ] 对象存储已配置
- [ ] CDN 已配置并绑定域名
- [ ] 负载均衡器已配置（生产环境）
- [ ] 监控和日志系统已部署
- [ ] 备份策略已实施

## 相关文档

- [Nginx 配置指南](./nginx-config.md)
- [CDN 策略](./cdn-strategy.md)
- [监控和日志](./monitoring-logging.md)
- [ICP 合规检查清单](./icp-compliance-checklist.md)

## 参考链接

- [阿里云官方文档](https://help.aliyun.com/)
- [腾讯云官方文档](https://cloud.tencent.com/document)
- [工信部备案管理系统](https://beian.miit.gov.cn/)
